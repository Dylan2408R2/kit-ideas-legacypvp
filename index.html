<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PvP Kit Builder Short-Link</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root { --wa: #25D366; --bg: #121212; --gui: #c6c6c6; }
        body { background: var(--bg); color: white; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 10px; margin: 0; }
        h1 { color: var(--wa); text-shadow: 2px 2px #000; font-size: 1.4rem; margin: 10px 0; }
        
        /* Contenedor Inventario */
        .inventory-card { background: var(--gui); padding: 10px; border: 4px solid #555; box-shadow: inset -4px -4px 0 #333, inset 4px 4px 0 #fff; }
        .grid { display: grid; grid-template-columns: repeat(9, 40px); gap: 2px; }
        .slot { width: 36px; height: 36px; background: #8b8b8b; border: 2px solid; border-color: #373737 #fff #fff #373737; display: flex; justify-content: center; align-items: center; position: relative; }
        .item-img { width: 32px; height: 32px; image-rendering: pixelated; cursor: pointer; }
        .enchanted::after { content: ''; position: absolute; inset: 0; background: rgba(176, 0, 255, 0.3); box-shadow: inset 0 0 8px #aa00ff; }

        /* Picker de Items */
        .picker { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; background: #252525; padding: 12px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #444; max-width: 450px; }
        .drag-source { width: 44px; height: 44px; background: #333; border: 1px solid #555; display: flex; justify-content: center; align-items: center; cursor: grab; }

        .btn { margin-top: 20px; background: var(--wa); color: white; border: none; padding: 15px 35px; font-weight: bold; border-radius: 50px; cursor: pointer; box-shadow: 0 4px #128c3e; }
        #modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; border: 2px solid var(--wa); padding: 20px; z-index: 2000; border-radius: 12px; width: 250px; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1500; }
    </style>
</head>
<body>

    <h1>Legacy PvP Kit Maker</h1>
    
    <div class="picker" id="item-source">
        <!-- Generado por JS -->
    </div>

    <div class="inventory-card">
        <div class="grid" id="main-inv"></div>
        <div style="height:12px"></div>
        <div class="grid" id="hotbar"></div>
    </div>

    <button class="btn" onclick="sendWhatsApp()">ENVIAR AL GRUPO</button>

    <div class="overlay" id="overlay" onclick="closeModal()"></div>
    <div id="modal">
        <h3 id="mod-title" style="margin:0">Encantar</h3>
        <div id="mod-list" style="margin:15px 0"></div>
        <button class="btn" style="padding:10px; width:100%" onclick="closeModal()">Listo</button>
        <button class="btn" style="padding:10px; background:#a33; margin-top:8px; width:100%; box-shadow:none" onclick="deleteItem()">Eliminar</button>
    </div>

    <script>
        // DICCIONARIO DE IDs (Para que el link sea corto)
        const ITEMS = {
            1: { n: "Espada", u: "default/default_tool_diamondsword.png", e: true },
            2: { n: "Pala", u: "default/default_tool_diamondshovel.png", e: true },
            3: { n: "Hacha", u: "default/default_tool_diamondaxe.png", e: true },
            4: { n: "Manzana", u: "default/default_apple.png", e: false },
            5: { n: "Lava", u: "bucket/bucket_lava.png", e: false },
            6: { n: "Perla", u: "default/default_mese_crystal.png", e: false }, // Usando cristal como perla temporal
            7: { n: "TNT", u: "tnt/tnt_side.png", e: false }
        };

        const ENCHANTS = { a: "Filo V", b: "Empuje II", c: "ProtecciÃ³n IV", d: "Eficiencia V" };

        let inventory = Array(36).fill(null);
        let currentIdx = null;

        // Iniciar Picker
        const picker = document.getElementById('item-source');
        Object.keys(ITEMS).forEach(id => {
            picker.innerHTML += `<div class="drag-source" data-id="${id}"><img src="https://raw.githubusercontent.com/nebulimity/MoreLikeMinecraft/main/${ITEMS[id].u}" class="item-img"></div>`;
        });

        // Iniciar Slots
        const main = document.getElementById('main-inv');
        const hot = document.getElementById('hotbar');
        for (let i = 0; i < 36; i++) {
            const slot = document.createElement('div');
            slot.className = 'slot';
            slot.dataset.index = i;
            if (i < 27) main.appendChild(slot); else hot.appendChild(slot);

            new Sortable(slot, {
                group: 'shared',
                onAdd: (evt) => {
                    const id = evt.item.dataset.id;
                    if (id) {
                        inventory[i] = { id: id, enchants: [] };
                    } else {
                        const from = evt.from.dataset.index;
                        inventory[i] = inventory[from];
                        inventory[from] = null;
                    }
                    evt.item.remove();
                    render();
                }
            });
        }

        new Sortable(picker, { group: { name: 'shared', pull: 'clone', put: false }, sort: false });

        function render() {
            inventory.forEach((data, i) => {
                const slot = document.querySelector(`.slot[data-index="${i}"]`);
                slot.innerHTML = '';
                if (data) {
                    const item = ITEMS[data.id];
                    const img = document.createElement('img');
                    img.src = `https://raw.githubusercontent.com/nebulimity/MoreLikeMinecraft/main/${item.u}`;
                    img.className = 'item-img' + (data.enchants.length > 0 ? ' enchanted' : '');
                    img.onclick = () => openModal(i);
                    slot.appendChild(img);
                }
            });
        }

        function openModal(i) {
            currentIdx = i;
            const data = inventory[i];
            const item = ITEMS[data.id];
            if (!item.e) { if(confirm("Â¿Quitar Ã­tem?")) deleteItem(); return; }
            document.getElementById('mod-title').innerText = item.n;
            const list = document.getElementById('mod-list');
            list.innerHTML = '';
            Object.keys(ENCHANTS).forEach(code => {
                const has = data.enchants.includes(code);
                list.innerHTML += `<div><label><input type="checkbox" ${has?'checked':''} onchange="toggleEnc('${code}')"> ${ENCHANTS[code]}</label></div>`;
            });
            document.getElementById('modal').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }

        function toggleEnc(code) {
            const data = inventory[currentIdx];
            const idx = data.enchants.indexOf(code);
            if (idx > -1) data.enchants.splice(idx, 1); else data.enchants.push(code);
            render();
        }

        function deleteItem() { inventory[currentIdx] = null; closeModal(); render(); }
        function closeModal() { document.getElementById('modal').style.display = 'none'; document.getElementById('overlay').style.display = 'none'; }

        function sendWhatsApp() {
            if (!inventory.some(x => x !== null)) return alert("Inventario vacÃ­o");
            alert("Envialo a WhatsApp para que pueda ver tu idea");

            // COMPRESIÃ“N MÃXIMA
            let parts = [];
            inventory.forEach((data, i) => {
                if (data) {
                    // Formato: index_idEncantos (ej: 27_1ab)
                    parts.push(`${i}_${data.id}${data.enchants.join('')}`);
                }
            });
            
            const shortCode = parts.join('.');
            const url = window.location.origin + window.location.pathname + "#k=" + shortCode;

            let text = "*NUEVO KIT legacy pvp* âš”ï¸\n\nðŸ”— Mira el diseÃ±o aquÃ­:\n" + url;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        // DECODIFICACIÃ“N
        window.onload = () => {
            const hash = window.location.hash;
            if (hash.includes("#k=")) {
                const items = hash.split('#k=')[1].split('.');
                items.forEach(p => {
                    const [idx, content] = p.split('_');
                    const itemId = content[0];
                    const enchants = content.substring(1).split('');
                    inventory[parseInt(idx)] = { id: itemId, enchants: enchants };
                });
                render();
            }
        }
    </script>
</body>
</html>
